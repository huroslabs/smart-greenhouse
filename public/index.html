<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Greenhouse Dashboard</title>
		<link rel="icon" type="image/x-icon" href="/images/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&family=Viga&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        html {
            scroll-behavior: smooth;
        }

        .viga-regular {
            font-family: "Viga", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
    </style>

</head>

<body class="bg-gray-900 text-gray-100 min-h-screen font-sans flex flex-col">

    <header
        class="fixed top-0 left-0 right-0 border-b border-gray-700 flex justify-between items-center bg-gray-900 z-50 h-16 px-10">
        <div class="flex items-center space-x-2">
            <img src="/images/icon.png" alt="" class="max-w-[30px]">
            <span class="hidden md:block text-2xl font-bold">Smart Greenhouse</span>
        </div>
        <nav class="space-x-4">
            <a href="#monitoring-section" class="hover:text-green-400">Monitoring</a>
            <a href="#chart-section" class="hover:text-green-400">Chart</a>
            <a href="#control-section" class="hover:text-green-400">Control</a>
        </nav>
    </header>
    <main class="flex-grow pt-16">
        <h1 id="monitoring" class="viga-regular text-xl ml-6 md:ml-10 mt-10">Monitoring</h1>
        <section id="monitoring-section" class="p-3 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Rain Status Card -->
            <div class="bg-[#1d2a47] p-5 rounded-2xl border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <p id="ph-status" class="text-sm text-yellow-400 font-semibold">PH STATUS</p>
                        <p id="ph-condition" class="text-2xl font-bold mt-1 text-yellow-300">Dry</p>
                    </div>
                    <div class="text-right text-gray-400 ">
                        <div class="text-sm">Distribution</div>
                        <div class="text-xl"><span id="ph-value">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Water Level Card -->
            <div class="bg-[#1d2a47] p-5 rounded-2xl border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <p id="tds-status"  class="text-sm text-red-400 font-semibold">TDS STATUS</p>
                        <p id="tds-condition"  class="text-2xl font-bold mt-1 text-red-300">Low</p>
                        <!-- <p class="text-gray-400 text-sm">Low Level</p> -->
                    </div>

                    <div class="text-right text-gray-400 ">
                        <div class="text-sm">Distribution</div>
                        <div class="text-xl"><span id="tds-value">0</span> ppm</div>
                    </div>
                </div>
            </div>

            <!-- Water Level Card -->
            <div class="bg-[#1d2a47] p-5 rounded-2xl border border-gray-700 shadow-lg">
                <div class="flex justify-between items-center">
                    <div>
                        <p id="temp-status"  class="text-sm text-green-400 font-semibold">TEMPERATUR STATUS</p>
                        <p id="temp-condition"  class="text-2xl font-bold mt-1 text-green-300">Low</p>
                        <!-- <p class="text-gray-400 text-sm">Low Level</p> -->
                    </div>

                    <div class="text-right text-gray-400 ">
                        <div class="text-sm">Distribution</div>
                        <div class="text-xl"><span id="temp-value">0</span> Â°C</div>
                    </div>
                </div>
            </div>


        </section>

        <section class="p-3 md:p-6 grid grid-cols-1 md:grid-cols-12 gap-6">
            <!-- Grafik -->
            <div class="md:col-span-8">
                <h1 id="chart" class="viga-regular text-xl ml-5 mb-5">Analytics</h1>
                <div id="chart-section" class="bg-[#1d2a47] p-5 rounded-2xl border border-gray-700 shadow-lg ">
                    <canvas id="rainChart" class="w-full" style="max-height: 480px;"></canvas>
                </div>
            </div>


            <!-- Kanan: dua card tombol -->
            <div class="md:col-span-4 flex flex-col gap-6">
                <h1 id="control" class="viga-regular text-xl ml-5">Control Panel</h1>
                <!-- Card 1 -->
                <div id="control-section"
                    class="bg-[#1d2a47] p-5 rounded-2xl border border-gray-700 shadow-lg flex flex-col">
                    <div class="flex justify-between items-center mb-5">
                        <p id="button1-title" class="font-semibold text-red-400 flex items-center gap-2"><span>âš¡</span>
                            Custom Control</p>
                        <span id="button1-status" class="text-xs bg-gray-700 px-3 py-1 rounded-full">INACTIVE</span>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Toggle control to turn ON/OFF electrical devices like lamps,
                        pumps, or other appliances.</p>
                    <div class="flex justify-between items-center mb-2 mt-5 ">
                        <p class="text-gray-400 text-sm ">Latest status: <span id="button1-text"
                                class="text-red-400 font-semibold">OFF</span></p>
                        <button id="button1"
                            class="flex-1 max-w-[150px] bg-gray-200 text-black font-semibold py-2 rounded-xl hover:bg-white">Turn
                            ON</button>
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="bg-[#1d2a47] p-5 rounded-2xl border border-gray-700 shadow-lg flex flex-col">
                    <div class="flex justify-between items-center mb-5">
                        <p id="button2-title" class="font-semibold text-red-400 flex items-center gap-2"><span>ðŸ’§</span>
                            Water Pump</p>
                        <span id="button2-status" class="text-xs bg-gray-700 px-3 py-1 rounded-full">ACTIVE</span>
                    </div>
                    <p class="text-gray-400 text-sm mb-2">Manual control for water pump system.</p>
                    <div class="flex justify-between items-center mb-2 mt-5">
                        <p class="text-gray-400 text-sm ">Latest status: <span id="button2-text"
                                class="text-red-400 font-semibold ">OFF</span></p>
                        <button id="button2"
                            class="flex-1 max-w-[150px] bg-gray-200 text-black font-semibold py-2 rounded-xl hover:bg-white">Turn
                            ON</button>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="p-6 text-center text-gray-500 border-t border-gray-700 mt-6">
        Smart Greenhouse Â© 2025 â€” Huros. All rights reserved.
    </footer>



    <script>
        const ctx = document.getElementById('rainChart').getContext('2d');

        // Inisialisasi chart kosong dengan label bulan
        const Charts = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],  
                datasets: [
                    {
                        label: 'PH',
                        data: [], 
                        borderColor: 'rgba(234, 179, 8, 1)',
                        // backgroundColor: 'rgba(234, 179, 8, 0.2)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(234, 179, 8, 1)'
                    },
                    {
                        label: 'TDS',
                        data: [],  
                        borderColor: 'rgba(239, 68, 68, 1)',  // red-500
                        // backgroundColor: 'rgba(239, 68, 68, 0.2)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(239, 68, 68, 1)'
                    },
                    {
                        label: 'Temperature',
                        data: [],  
                        borderColor: 'rgba(34, 197, 94, 1)',  // green-500
                        // backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgba(34, 197, 94, 1)'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        min: 0,
                        ticks: {
                            color: '#eab308'
                        },
                        grid: {
                            color: '#374151'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#eab308'
                        },
                        grid: {
                            color: '#374151'
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: '#facc15'
                        }
                    }
                }
            }
        });
    </script>
    <script>
        async function loadData() {
            const res = await fetch('/api/data');
            const rows = await res.json();
            const labels = rows.map(row => {
								const d = new Date(row.created_at);

								const day = String(d.getDate()).padStart(2, "0");
								const month = String(d.getMonth() + 1).padStart(2, "0");
								const year = d.getFullYear();

								const hours = String(d.getHours()).padStart(2, "0");
								const minutes = String(d.getMinutes()).padStart(2, "0");

								return `${day} ${hours}:${minutes}`;
						});

            const phData = rows.map(row => row.ph);
            const tdsData = rows.map(row => row.tds);
            const temperatureData = rows.map(row => row.temperature);

            
            // Update chart
            Charts.data.labels = labels;
            Charts.data.datasets[0].data = phData;
            Charts.data.datasets[1].data = tdsData;
            Charts.data.datasets[2].data = temperatureData;
            
            const MAX_POINTS = 100;
            if (Charts.data.labels.length > MAX_POINTS) {
                Charts.data.labels.splice(0, Charts.data.labels.length - MAX_POINTS);
                Charts.data.datasets.forEach(ds => {
                    ds.data.splice(0, ds.data.length - MAX_POINTS);
                });
            }
            
            Charts.update();

            const lastRow = rows[rows.length - 1];
            const phDataVal = [lastRow.ph];
            const tdsDataVal = [lastRow.tds];
            const tempDataVal = [lastRow.temperature];

            const phStatus = document.getElementById(`ph-status`);
            const phCondition = document.getElementById(`ph-condition`);
            const phValue = document.getElementById(`ph-value`);
            const tdsStatus = document.getElementById(`tds-status`);
            const tdsCondition = document.getElementById(`tds-condition`);
            const tdsValue = document.getElementById(`tds-value`);
            const tempStatus = document.getElementById(`temp-status`);
            const tempCondition = document.getElementById(`temp-condition`);
            const tempValue = document.getElementById(`temp-value`);

            if(phDataVal  < 5.5 ) {
                phStatus.classList.remove('text-green-400')
                phStatus.classList.add('text-yellow-400')
                phStatus.classList.remove('text-red-400')

                phCondition.classList.remove('text-green-300')
                phCondition.classList.add('text-yellow-300')
                phCondition.classList.remove('text-red-300')

                phCondition.textContent ="LOW"

            }
            else if(phDataVal > 5.5 && phDataVal < 7.5 ) {
                phStatus.classList.add('text-green-400')
                phStatus.classList.remove('text-yellow-400')
                phStatus.classList.remove('text-red-400')

                phCondition.classList.add('text-green-300')
                phCondition.classList.remove('text-yellow-300')
                phCondition.classList.remove('text-red-300')

                 phCondition.textContent ="NORMAL"
            }
            else {
                phStatus.classList.remove('text-green-400')
                phStatus.classList.remove('text-yellow-400')
                phStatus.classList.add('text-red-400')

                phCondition.classList.remove('text-green-300')
                phCondition.classList.remove('text-yellow-300')
                phCondition.classList.add('text-red-300')

                phCondition.textContent ="HIGH"
            }

            if(tdsDataVal  < 200 ) {
                tdsStatus.classList.remove('text-green-400')
                tdsStatus.classList.add('text-yellow-400')
                tdsStatus.classList.remove('text-red-400')

                tdsCondition.classList.remove('text-green-300')
                tdsCondition.classList.add('text-yellow-300')
                tdsCondition.classList.remove('text-red-300')

                tdsCondition.textContent ="LOW"

            }
            else if(tdsDataVal >= 200 && tdsDataVal < 500 ) {
                tdsStatus.classList.add('text-green-400')
                tdsStatus.classList.remove('text-yellow-400')
                tdsStatus.classList.remove('text-red-400')

                tdsCondition.classList.add('text-green-300')
                tdsCondition.classList.remove('text-yellow-300')
                tdsCondition.classList.remove('text-red-300')


                tdsCondition.textContent ="NORMAL"
            }
            else {
                tdsStatus.classList.remove('text-green-400')
                tdsStatus.classList.remove('text-yellow-400')
                tdsStatus.classList.add('text-red-400')

                tdsCondition.classList.remove('text-green-300')
                tdsCondition.classList.remove('text-yellow-300')
                tdsCondition.classList.add('text-red-300')

                tdsCondition.textContent ="HIGH"
            }


            if(tempDataVal  < 18 ) {
                tempStatus.classList.remove('text-green-400')
                tempStatus.classList.add('text-yellow-400')
                tempStatus.classList.remove('text-red-400')

                tempCondition.classList.remove('text-green-300')
                tempCondition.classList.add('text-yellow-300')
                tempCondition.classList.remove('text-red-300')

                tempCondition.textContent ="COLD"

            }
            else if(tempDataVal >= 18 && tempDataVal < 28 ) {
                tempStatus.classList.add('text-green-400')
                tempStatus.classList.remove('text-yellow-400')
                tempStatus.classList.remove('text-red-400')

                tempCondition.classList.add('text-green-300')
                tempCondition.classList.remove('text-yellow-300')
                tempCondition.classList.remove('text-red-300')

                tempCondition.textContent ="IDEAL"
            }
            else {
                tempStatus.classList.remove('text-green-400')
                tempStatus.classList.remove('text-yellow-400')
                tempStatus.classList.add('text-red-400')

                tempCondition.classList.remove('text-green-300')
                tempCondition.classList.remove('text-yellow-300')
                tempCondition.classList.add('text-red-300')

                tempCondition.textContent ="HOT"
            }

            phValue.textContent=phDataVal;
            tdsValue.textContent=tdsDataVal;
            tempValue.textContent=tempDataVal;
        }

        async function fetchStatus() {
            const res = await fetch('/api/controls');
            const controls = await res.json();

            controls.forEach(c => {
                const btn = document.getElementById(c.name);
                const textBtn = document.getElementById(`${c.name}-text`);
                const statusBtn = document.getElementById(`${c.name}-status`);
                const titleBtn = document.getElementById(`${c.name}-title`);
                if (!btn) return;

                if (c.status === 1) {
                    btn.textContent = `Turn OFF`;
                    textBtn.textContent = `ON`
                    statusBtn.textContent = `ACTIVE`

                    textBtn.classList.add('text-green-400');
                    textBtn.classList.remove('text-red-400');
                    titleBtn.classList.add('text-green-400');
                    titleBtn.classList.remove('text-red-400');

                    btn.classList.add('control-on');
                    btn.classList.remove('control-off');
                } else {
                    btn.textContent = `Turn ON`;
                    textBtn.textContent = `OFF`
                    statusBtn.textContent = `INACTIVE`
                    textBtn.classList.add('text-red-400');
                    textBtn.classList.remove('text-green-400');
                    titleBtn.classList.add('text-red-400');
                    titleBtn.classList.remove('text-green-400');
                    btn.classList.add('control-off');
                    btn.classList.remove('control-on');
                }
            });
        }

        async function toggleButton(name) {
            const btn = document.getElementById(name);
            const isOn = btn.classList.contains('control-on');
            const newStatus = isOn ? 0 : 1;

            console.log(newStatus)

            const res = await fetch(`/api/controls/${name}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });

            if (res.ok) {
                fetchStatus();
            } else {
                alert('Gagal update status');
            }
        }

        document.getElementById('button1').addEventListener('click', () => toggleButton('button1'));
        document.getElementById('button2').addEventListener('click', () => toggleButton('button2'));

        fetchStatus();
        loadData();

        setInterval(fetchStatus, 5000);
        setInterval(loadData, 3000);
    </script>




</body>

</html>